!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CirclePacker=t()}(this,function(){"use strict";function e(e,t){e.postMessage(JSON.stringify(t))}function t(e){return e.data?JSON.parse(e.data):{}}function i(e){return e&&null!==e.id&&void 0!==e.id&&e.radius&&e.position&&"number"==typeof e.position.x&&"number"==typeof e.position.y}function r(e){return e&&"number"==typeof e.width&&"number"==typeof e.height}var o=function(e){void 0===e&&(e={}),this.worker=new Worker(URL.createObjectURL(new Blob(['function sendWorkerMessage(e,i){e.postMessage(JSON.stringify(i))}function processWorkerMessage(e){return e.data?JSON.parse(e.data):{}}function receivedMessage(e){var i=processWorkerMessage(e),t=i.type,r=i.message;"bounds"===t&&circleManager.setBounds(r),"target"===t&&setTarget(r),"addcircles"===t&&addCircles(r),"removecircle"===t&&circleManager.removeCircle(r),"update"===t&&update(),"dragstart"===t&&circleManager.dragStart(r.id,r.position),"drag"===t&&circleManager.drag(r.id,r.position),"dragend"===t&&circleManager.dragEnd(r.id),"pincircle"===t&&circleManager.pinCircle(r),"unpincircle"===t&&circleManager.unpinCircle(r),"centeringpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCenteringPasses=r),"collisionpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCollisionPasses=r),"damping"===t&&"number"==typeof r&&r>0&&(circleManager.damping=r),"circleradius"===t&&circleManager.setCircleRadius(r.id,r.radius),"circlecenterpull"===t&&circleManager.setCircleCenterPull(r.id,r.centerPull),"centerpull"===t&&circleManager.setCenterPull(r.centerPull)}function updatePage(e,i){sendWorkerMessage(self,{type:e,message:i})}function addCircles(e){Array.isArray(e)&&e.length&&e.forEach(circleManager.addCircle.bind(circleManager))}function setTarget(e){e&&"number"==typeof e.x&&"number"==typeof e.y&&circleManager.setTarget(new Vector(e))}function update(){circleManager.updatePositions(),sendPositions()}function sendPositions(){var e=circleManager.allCircles.reduce(function(e,i){return e[i.id]={position:i.position,previousPosition:i.previousPosition,radius:i.radius,delta:i.delta,isPulledToCenter:i.isPulledToCenter,isPinned:i.isPinned},e},{});updatePage("move",e)}var Vector=function(e,i){"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)};Vector.prototype.cp=function(){return new Vector(this.x,this.y)},Vector.prototype.mul=function(e){return this.x*=e,this.y*=e,this},Vector.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,this},Vector.prototype.length=function e(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return e<.005&&e>-.005?1e-6:e},Vector.prototype.distance=function(e){var i=this.x-e.x,t=this.y-e.y;return Math.sqrt(i*i+t*t)},Vector.prototype.distanceSquared=function(e){var i=this.x-e.x,t=this.y-e.y;return i*i+t*t};var PackedCircle=function(e){var i=e.id,t=e.radius,r=e.x,s=e.y,n=e.isPulledToCenter,o=e.isPinned;r=r||0,s=s||0,this.id=i,this.targetPosition=new Vector(0,0),this.position=new Vector(r,s),this.previousPosition=new Vector(r,s),this.positionWithOffset=new Vector(r,s),this.previousPositionWithOffset=new Vector(r,s),this.isPulledToCenter=n,this.isPinned=o,this.setRadius(t)},prototypeAccessors={delta:{}};PackedCircle.prototype.setPosition=function(e){this.previousPosition=this.position,this.position=e.cp()},PackedCircle.prototype.distanceSquaredFromTargetPosition=function(){var e=this.position.distanceSquared(this.targetPosition);return e<this.radiusSquared},PackedCircle.prototype.setRadius=function(e){this.radius=e,this.radiusSquared=e*e,this.originalRadius=e},prototypeAccessors.delta.get=function(){return new Vector(this.position.x-this.previousPosition.x,this.position.y-this.previousPosition.y)},Object.defineProperties(PackedCircle.prototype,prototypeAccessors);var PackedCircleManager=function(){this.allCircles=[],this.pinnedCircleIds=[],this.desiredTarget=new Vector(0,0),this.bounds={left:0,top:0,right:0,bottom:0},this.damping=.025,this.numberOfCenteringPasses=1,this.numberOfCollisionPasses=3,this.isCenterPullActive=!0};PackedCircleManager.prototype.setBounds=function(e){"number"==typeof e.left&&(this.bounds.left=e.left),"number"==typeof e.right&&(this.bounds.right=e.right),"number"==typeof e.top&&(this.bounds.top=e.top),"number"==typeof e.bottom&&(this.bounds.bottom=e.bottom),"number"==typeof e.width&&(this.bounds.right=this.bounds.left+e.width),"number"==typeof e.height&&(this.bounds.bottom=this.bounds.top+e.height)},PackedCircleManager.prototype.addCircle=function(e){e instanceof PackedCircle||(e=new PackedCircle({id:e.id,radius:e.radius,x:e.position.x||0,y:e.position.y||0,isPinned:e.isPinned||!1,isPulledToCenter:"boolean"!=typeof e.isPulledToCenter||e.isPulledToCenter})),this.allCircles.push(e),e.targetPosition=this.desiredTarget.cp()},PackedCircleManager.prototype.removeCircle=function(e){for(var i=this,t=this.allCircles.reduce(function(i,t,r){return t.id===e&&i.push(r),i},[]),r=t.length-1;r>=0;r--)i.allCircles.splice(t[r],1)},PackedCircleManager.prototype.updatePositions=function(){for(var e=this,i=this.allCircles,t=i.length,r=0;r<t;++r){var s=i[r];s.previousPosition=s.position.cp()}this.desiredTarget&&this.isCenterPullActive&&this.pushAllCirclesTowardTarget(this.desiredTarget),this.handleCollisions();for(var n=0;n<t;++n){var o=i[n];e.handleBoundaryForCircle(o)}},PackedCircleManager.prototype.pushAllCirclesTowardTarget=function(e){for(var i=this,t=new Vector(0,0),r=this.draggedCircle,s=this.allCircles,n=s.length,o=0;o<this.numberOfCenteringPasses;o++)for(var a=0;a<n;a++){var c=s[a];if(c.isPulledToCenter){var d=c===r||i.isCirclePinned(c.id);if(d)continue;t.x=c.position.x-e.x,t.y=c.position.y-e.y,t.mul(i.damping),c.position.x-=t.x,c.position.y-=t.y}}},PackedCircleManager.prototype.handleCollisions=function(){for(var e=this,i=new Vector(0,0),t=this.draggedCircle,r=this.allCircles,s=r.length,n=0;n<this.numberOfCollisionPasses;n++)for(var o=0;o<s;o++)for(var a=r[o],c=o+1;c<s;c++){var d=r[c],l=e.isCirclePinned(a.id),u=e.isCirclePinned(d.id),p=a===t||l,h=d===t||u;if(!(a===d||p&&h)){var g=d.position.x-a.position.x,C=d.position.y-a.position.y,f=1.08*(a.radius+d.radius),y=a.position.distanceSquared(d.position);if(y<f*f-.02){i.x=g,i.y=C,i.normalize();var P=.5*(f-Math.sqrt(y));i.mul(P),h||(p&&i.mul(2.2),d.position.x+=i.x,d.position.y+=i.y),p||(h&&i.mul(2.2),a.position.x-=i.x,a.position.y-=i.y)}}}},PackedCircleManager.prototype.handleBoundaryForCircle=function(e){var i=e.position.x,t=e.position.y,r=e.radius,s=!1;i+r>=this.bounds.right?(e.position.x=this.bounds.right-r,s=!0):i-r<this.bounds.left&&(e.position.x=this.bounds.left+r,s=!0),t+r>this.bounds.bottom?(e.position.y=this.bounds.bottom-r,s=!0):t-r<this.bounds.top&&(e.position.y=this.bounds.top+r,s=!0),s&&e===this.draggedCircle&&(this.draggedCircle=null)},PackedCircleManager.prototype.setDraggedCircle=function(e){this.draggedCircle&&this.draggedCircle!==e&&(this.draggedCircle.radius=this.draggedCircle.originalRadius),this.draggedCircle=e},PackedCircleManager.prototype.dragStart=function(e){var i=this.allCircles.filter(function(i){return i.id===e})[0];this.setDraggedCircle(i)},PackedCircleManager.prototype.dragEnd=function(e){this.draggedCircle&&this.setDraggedCircle(null)},PackedCircleManager.prototype.drag=function(e,i){this.draggedCircle&&i&&(this.draggedCircle.position.x=i.x,this.draggedCircle.position.y=i.y)},PackedCircleManager.prototype.isCirclePinned=function(e){var i=this.circleById(e);return!!i&&i.isPinned},PackedCircleManager.prototype.pinCircle=function(e){var i=this.circleById(e);i&&(i.isPinned=!0)},PackedCircleManager.prototype.unpinCircle=function(e){var i=this.circleById(e);i&&(i.isPinned=!1)},PackedCircleManager.prototype.setCircleRadius=function(e,i){var t=this.circleById(e);t&&t.setRadius(i)},PackedCircleManager.prototype.setCircleCenterPull=function(e,i){var t=this.circleById(e);t&&(t.isPulledToCenter=i)},PackedCircleManager.prototype.setCenterPull=function(e){this.isCenterPullActive=e},PackedCircleManager.prototype.circleById=function(e){return this.allCircles.filter(function(i){return i.id===e})[0]},PackedCircleManager.prototype.setTarget=function(e){this.desiredTarget=e},self.addEventListener("message",receivedMessage);var circleManager=new PackedCircleManager;'],{type:"text/javascript"}))),this.worker.addEventListener("message",this.receivedWorkerMessage.bind(this)),this.isContinuousModeActive="boolean"!=typeof e.continuousMode||e.continuousMode,this.onMoveStart=e.onMoveStart||null,this.onMove=e.onMove||null,this.onMoveEnd=e.onMoveEnd||null,this.lastCirclePositions=[],e.centeringPasses&&this.setCenteringPasses(e.centeringPasses),e.collisionPasses&&this.setCollisionPasses(e.collisionPasses),this.addCircles(e.circles||[]),this.setBounds(e.bounds||{width:100,height:100}),this.setTarget(e.target||{x:50,y:50}),this.isLooping=!1,this.areItemsMoving=!0,this.animationFrameId=NaN,this.initialized=!0,this.isContinuousModeActive&&this.startLoop()};return o.prototype.receivedWorkerMessage=function(e){var i=t(e);if("move"===i.type){var r=i.message;this.areItemsMoving=this.hasItemMoved(r),!this.areItemsMoving&&this.isLooping&&this.initialized&&this.isContinuousModeActive&&this.stopLoop()}this.updateListeners(i)},o.prototype.updateWorker=function(t,i){e(this.worker,{type:t,message:i})},o.prototype.updateListeners=function(e){var t=e.type,i=e.message;"movestart"===t&&"function"==typeof this.onMoveStart&&this.onMoveStart(i),"move"===t&&"function"==typeof this.onMove&&(this.lastCirclePositions=i,this.onMove(i)),"moveend"===t&&"function"==typeof this.onMoveEnd&&this.onMoveEnd(i)},o.prototype.addCircles=function(e){if(Array.isArray(e)&&e.length){var t=e.filter(i);t.length&&this.updateWorker("addcircles",t)}this.startLoop()},o.prototype.addCircle=function(e){this.addCircles([e])},o.prototype.removeCircle=function(e){e&&(e.id?this.updateWorker("removecircle",e.id):this.updateWorker("removecircle",e),this.startLoop())},o.prototype.pinCircle=function(e){e&&(e.id?this.updateWorker("pincircle",e.id):this.updateWorker("pincircle",e),this.startLoop())},o.prototype.unpinCircle=function(e){e&&(e.id?this.updateWorker("unpincircle",e.id):this.updateWorker("unpincircle",e),this.startLoop())},o.prototype.setCircleRadius=function(e,t){e&&t>=0&&(e.id?this.updateWorker("circleradius",{id:e.id,radius:t}):this.updateWorker("circleradius",{id:e,radius:t}),this.startLoop())},o.prototype.setCircleCenterPull=function(e,t){e&&(e.id?this.updateWorker("circlecenterpull",{id:e.id,centerPull:!!t}):this.updateWorker("circlecenterpull",{id:e,centerPull:!!t}),this.startLoop())},o.prototype.setCenterPull=function(e){this.updateWorker("centerpull",{centerPull:!!e}),this.startLoop()},o.prototype.setBounds=function(e){r(e)&&(this.updateWorker("bounds",e),this.startLoop())},o.prototype.setTarget=function(e){this.updateWorker("target",e),this.startLoop()},o.prototype.setCenteringPasses=function(e){this.updateWorker("centeringpasses",e)},o.prototype.setCollisionPasses=function(e){this.updateWorker("collisionpasses",e)},o.prototype.setDamping=function(e){this.updateWorker("damping",e)},o.prototype.update=function(){this.updateWorker("update")},o.prototype.dragStart=function(e){this.updateWorker("dragstart",{id:e}),this.startLoop()},o.prototype.drag=function(e,t){this.updateWorker("drag",{id:e,position:t}),this.startLoop()},o.prototype.dragEnd=function(e){this.updateWorker("dragend",{id:e}),this.startLoop()},o.prototype.updateLoop=function(){this.update(),this.isLooping&&(this.areItemsMoving?this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)):this.stopLoop())},o.prototype.startLoop=function(){!this.isLooping&&this.initialized&&this.isContinuousModeActive&&(this.isLooping=!0,this.isContinuousModeActive&&(this.areItemsMoving=!0),this.updateListeners({type:"movestart"}),this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)))},o.prototype.stopLoop=function(){this.isLooping&&(this.isLooping=!1,this.updateListeners({type:"moveend",message:this.lastCirclePositions}),cancelAnimationFrame(this.animationFrameId))},o.prototype.hasItemMoved=function(e){var t=!1;for(var i in e)(Math.abs(e[i].delta.x)>.005||Math.abs(e[i].delta.y)>.005)&&(t=!0);return t},o.prototype.destroy=function(){this.worker&&this.worker.terminate(),this.stopLoop(),this.onMove=null,this.onMoveStart=null,this.onMoveEnd=null},o});