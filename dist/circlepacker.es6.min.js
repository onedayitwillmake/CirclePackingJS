function sendWorkerMessage(i,t){i.postMessage(JSON.stringify(t))}function processWorkerMessage(i){return i.data?JSON.parse(i.data):{}}function isCircleValid(i){return i&&null!==i.id&&void 0!==i.id&&i.radius&&i.position&&"number"==typeof i.position.x&&"number"==typeof i.position.y}function isBoundsValid(i){return i&&"number"==typeof i.width&&"number"==typeof i.height}class i{constructor(i={}){this.worker=new Worker(URL.createObjectURL(new Blob(['function sendWorkerMessage(i,t){i.postMessage(JSON.stringify(t))}function processWorkerMessage(i){return i.data?JSON.parse(i.data):{}}function receivedMessage(i){const{type,message}=processWorkerMessage(i);"bounds"===type&&e.setBounds(message),"target"===type&&setTarget(message),"addcircles"===type&&addCircles(message),"removecircle"===type&&e.removeCircle(message),"update"===type&&update(),"dragstart"===type&&e.dragStart(message.id,message.position),"drag"===type&&e.drag(message.id,message.position),"dragend"===type&&e.dragEnd(message.id),"pincircle"===type&&e.pinCircle(message),"unpincircle"===type&&e.unpinCircle(message),"centeringpasses"===type&&"number"==typeof message&&message>0&&(e.numberOfCenteringPasses=message),"collisionpasses"===type&&"number"==typeof message&&message>0&&(e.numberOfCollisionPasses=message),"damping"===type&&"number"==typeof message&&message>0&&(e.damping=message),"circleradius"===type&&e.setCircleRadius(message.id,message.radius),"circlecenterpull"===type&&e.setCircleCenterPull(message.id,message.centerPull),"centerpull"===type&&e.setCenterPull(message.centerPull)}function updatePage(i,t){sendWorkerMessage(self,{type:i,message:t})}function addCircles(i){Array.isArray(i)&&i.length&&i.forEach(e.addCircle.bind(e))}function setTarget(t){t&&"number"==typeof t.x&&"number"==typeof t.y&&e.setTarget(new i(t))}function update(){e.updatePositions(),sendPositions()}function sendPositions(){const i=e.allCircles.reduce((i,t)=>{return i[t.id]={position:t.position,previousPosition:t.previousPosition,radius:t.radius,delta:t.delta,isPulledToCenter:t.isPulledToCenter,isPinned:t.isPinned},i},{});updatePage("move",i)}class i{constructor(i,t){"object"==typeof i?(this.x=i.x,this.y=i.y):(this.x=i,this.y=t)}cp(){return new i(this.x,this.y)}mul(i){return this.x*=i,this.y*=i,this}normalize(){var i=this.length();return this.x/=i,this.y/=i,this}length(){var i=Math.sqrt(this.x*this.x+this.y*this.y);return i<.005&&i>-.005?1e-6:i}distance(i){var t=this.x-i.x,s=this.y-i.y;return Math.sqrt(t*t+s*s)}distanceSquared(i){var t=this.x-i.x,s=this.y-i.y;return t*t+s*s}}class t{constructor({id,radius,x,y,isPulledToCenter,isPinned}){x=x||0,y=y||0,this.id=id,this.targetPosition=new i(0,0),this.position=new i(x,y),this.previousPosition=new i(x,y),this.positionWithOffset=new i(x,y),this.previousPositionWithOffset=new i(x,y),this.isPulledToCenter=isPulledToCenter,this.isPinned=isPinned,this.setRadius(radius)}setPosition(i){this.previousPosition=this.position,this.position=i.cp()}distanceSquaredFromTargetPosition(){var i=this.position.distanceSquared(this.targetPosition);return i<this.radiusSquared}setRadius(i){this.radius=i,this.radiusSquared=i*i,this.originalRadius=i}get delta(){return new i(this.position.x-this.previousPosition.x,this.position.y-this.previousPosition.y)}}class s{constructor(){this.allCircles=[],this.pinnedCircleIds=[],this.desiredTarget=new i(0,0),this.bounds={left:0,top:0,right:0,bottom:0},this.damping=.025,this.numberOfCenteringPasses=1,this.numberOfCollisionPasses=3,this.isCenterPullActive=!0}setBounds(i){"number"==typeof i.left&&(this.bounds.left=i.left),"number"==typeof i.right&&(this.bounds.right=i.right),"number"==typeof i.top&&(this.bounds.top=i.top),"number"==typeof i.bottom&&(this.bounds.bottom=i.bottom),"number"==typeof i.width&&(this.bounds.right=this.bounds.left+i.width),"number"==typeof i.height&&(this.bounds.bottom=this.bounds.top+i.height)}addCircle(i){i instanceof t||(i=new t({id:i.id,radius:i.radius,x:i.position.x||0,y:i.position.y||0,isPinned:i.isPinned||!1,isPulledToCenter:"boolean"!=typeof i.isPulledToCenter||i.isPulledToCenter})),this.allCircles.push(i),i.targetPosition=this.desiredTarget.cp()}removeCircle(i){const t=this.allCircles.reduce((t,s,e)=>{return s.id===i&&t.push(e),t},[]);for(let s=t.length-1;s>=0;s--)this.allCircles.splice(t[s],1)}updatePositions(){var i=this.allCircles,t=i.length;for(let s=0;s<t;++s){const t=i[s];t.previousPosition=t.position.cp()}this.desiredTarget&&this.isCenterPullActive&&this.pushAllCirclesTowardTarget(this.desiredTarget),this.handleCollisions();for(let s=0;s<t;++s){const t=i[s];this.handleBoundaryForCircle(t)}}pushAllCirclesTowardTarget(t){for(var s=new i(0,0),e=this.draggedCircle,n=this.allCircles,o=n.length,r=0;r<this.numberOfCenteringPasses;r++)for(var d=0;d<o;d++){var u=n[d];if(u.isPulledToCenter){const i=u===e||this.isCirclePinned(u.id);if(i)continue;s.x=u.position.x-t.x,s.y=u.position.y-t.y,s.mul(this.damping),u.position.x-=s.x,u.position.y-=s.y}}}handleCollisions(){for(var t=new i(0,0),s=this.draggedCircle,e=this.allCircles,n=e.length,o=0;o<this.numberOfCollisionPasses;o++)for(var r=0;r<n;r++)for(var d=e[r],u=r+1;u<n;u++){var l=e[u];const i=this.isCirclePinned(d.id),n=this.isCirclePinned(l.id),o=d===s||i,r=l===s||n;if(!(d===l||o&&r)){var c=l.position.x-d.position.x,a=l.position.y-d.position.y,h=1.08*(d.radius+l.radius),p=d.position.distanceSquared(l.position);if(p<h*h-.02){t.x=c,t.y=a,t.normalize();var f=.5*(h-Math.sqrt(p));t.mul(f),r||(o&&t.mul(2.2),l.position.x+=t.x,l.position.y+=t.y),o||(r&&t.mul(2.2),d.position.x-=t.x,d.position.y-=t.y)}}}}handleBoundaryForCircle(i){const t=i.position.x,s=i.position.y,e=i.radius;let n=!1;t+e>=this.bounds.right?(i.position.x=this.bounds.right-e,n=!0):t-e<this.bounds.left&&(i.position.x=this.bounds.left+e,n=!0),s+e>this.bounds.bottom?(i.position.y=this.bounds.bottom-e,n=!0):s-e<this.bounds.top&&(i.position.y=this.bounds.top+e,n=!0),n&&i===this.draggedCircle&&(this.draggedCircle=null)}setDraggedCircle(i){this.draggedCircle&&this.draggedCircle!==i&&(this.draggedCircle.radius=this.draggedCircle.originalRadius),this.draggedCircle=i}dragStart(i){const t=this.allCircles.filter(t=>t.id===i)[0];this.setDraggedCircle(t)}dragEnd(i){this.draggedCircle&&this.setDraggedCircle(null)}drag(i,t){this.draggedCircle&&t&&(this.draggedCircle.position.x=t.x,this.draggedCircle.position.y=t.y)}isCirclePinned(i){const t=this.circleById(i);return!!t&&t.isPinned}pinCircle(i){const t=this.circleById(i);t&&(t.isPinned=!0)}unpinCircle(i){const t=this.circleById(i);t&&(t.isPinned=!1)}setCircleRadius(i,t){const s=this.circleById(i);s&&s.setRadius(t)}setCircleCenterPull(i,t){const s=this.circleById(i);s&&(s.isPulledToCenter=t)}setCenterPull(i){this.isCenterPullActive=i}circleById(i){return this.allCircles.filter(t=>t.id===i)[0]}setTarget(i){this.desiredTarget=i}}self.addEventListener("message",receivedMessage);const e=new s;'],{type:"text/javascript"}))),this.worker.addEventListener("message",this.receivedWorkerMessage.bind(this)),this.isContinuousModeActive="boolean"!=typeof i.continuousMode||i.continuousMode,this.onMoveStart=i.onMoveStart||null,this.onMove=i.onMove||null,this.onMoveEnd=i.onMoveEnd||null,this.lastCirclePositions=[],i.centeringPasses&&this.setCenteringPasses(i.centeringPasses),i.collisionPasses&&this.setCollisionPasses(i.collisionPasses),this.addCircles(i.circles||[]),this.setBounds(i.bounds||{width:100,height:100}),this.setTarget(i.target||{x:50,y:50}),this.isLooping=!1,this.areItemsMoving=!0,this.animationFrameId=NaN,this.initialized=!0,this.isContinuousModeActive&&this.startLoop()}receivedWorkerMessage(i){const t=processWorkerMessage(i);if("move"===t.type){const i=t.message;this.areItemsMoving=this.hasItemMoved(i),!this.areItemsMoving&&this.isLooping&&this.initialized&&this.isContinuousModeActive&&this.stopLoop()}this.updateListeners(t)}updateWorker(i,t){sendWorkerMessage(this.worker,{type:i,message:t})}updateListeners({type,message}){"movestart"===type&&"function"==typeof this.onMoveStart&&this.onMoveStart(message),"move"===type&&"function"==typeof this.onMove&&(this.lastCirclePositions=message,this.onMove(message)),"moveend"===type&&"function"==typeof this.onMoveEnd&&this.onMoveEnd(message)}addCircles(i){if(Array.isArray(i)&&i.length){const t=i.filter(isCircleValid);t.length&&this.updateWorker("addcircles",t)}this.startLoop()}addCircle(i){this.addCircles([i])}removeCircle(i){i&&(i.id?this.updateWorker("removecircle",i.id):this.updateWorker("removecircle",i),this.startLoop())}pinCircle(i){i&&(i.id?this.updateWorker("pincircle",i.id):this.updateWorker("pincircle",i),this.startLoop())}unpinCircle(i){i&&(i.id?this.updateWorker("unpincircle",i.id):this.updateWorker("unpincircle",i),this.startLoop())}setCircleRadius(i,t){i&&t>=0&&(i.id?this.updateWorker("circleradius",{id:i.id,radius:t}):this.updateWorker("circleradius",{id:i,radius:t}),this.startLoop())}setCircleCenterPull(i,t){i&&(i.id?this.updateWorker("circlecenterpull",{id:i.id,centerPull:!!t}):this.updateWorker("circlecenterpull",{id:i,centerPull:!!t}),this.startLoop())}setCenterPull(i){this.updateWorker("centerpull",{centerPull:!!i}),this.startLoop()}setBounds(i){isBoundsValid(i)&&(this.updateWorker("bounds",i),this.startLoop())}setTarget(i){this.updateWorker("target",i),this.startLoop()}setCenteringPasses(i){this.updateWorker("centeringpasses",i)}setCollisionPasses(i){this.updateWorker("collisionpasses",i)}setDamping(i){this.updateWorker("damping",i)}update(){this.updateWorker("update")}dragStart(i){this.updateWorker("dragstart",{id:i}),this.startLoop()}drag(i,t){this.updateWorker("drag",{id:i,position:t}),this.startLoop()}dragEnd(i){this.updateWorker("dragend",{id:i}),this.startLoop()}updateLoop(){this.update(),this.isLooping&&(this.areItemsMoving?this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)):this.stopLoop())}startLoop(){!this.isLooping&&this.initialized&&this.isContinuousModeActive&&(this.isLooping=!0,this.isContinuousModeActive&&(this.areItemsMoving=!0),this.updateListeners({type:"movestart"}),this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)))}stopLoop(){this.isLooping&&(this.isLooping=!1,this.updateListeners({type:"moveend",message:this.lastCirclePositions}),cancelAnimationFrame(this.animationFrameId))}hasItemMoved(i){let t=!1;for(let e in i)(Math.abs(i[e].delta.x)>.005||Math.abs(i[e].delta.y)>.005)&&(t=!0);return t}destroy(){this.worker&&this.worker.terminate(),this.stopLoop(),this.onMove=null,this.onMoveStart=null,this.onMoveEnd=null}}export default i;